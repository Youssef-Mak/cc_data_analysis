library(dplyr)
library(countrycode)
library(tidyr)
library(readxl)
library(janitor)
library(ggplot2)
library(ggfortify)
library(skimr)
library(stringr)
library(ggrepel)
library(tidyverse)
library(tsibble)
library(tseries)
library(countrycode)
library(plotly)


country_emissions_filename <- "data/raw/CAIT-Country-GHG-Emissions.csv"

# Value added reflects the value generated by producing goods and services, 
# Value Added = (value of output - value of intermediate consumption)/total value added)
# https://data.oecd.org/natincome/value-added-by-activity.htm#indicator-chart
activity_value_filename <- "data/raw/value_added_per_act.csv"

# http://www.lse.ac.uk/GranthamInstitute/climate-change-laws-of-the-world/
regulation_filename <- "data/raw/law_search/data.csv"

# https://data.oecd.org/envpolicy/environmental-tax.htm
emission_tax_filename <- "data/raw/emission_tax.csv"

# https://data.oecd.org/emp/employment-by-activity.htm
empl_per_act_filename <- "data/raw/employment_per_act.csv"

# SECTOR DEFINITION (Source: http://fenixservices.fao.org/faostat/static/documents/EM/EM_e.pdf )

# CO2 per sector
co2_per_sect <- "data/raw/emission_per_sect/global-carbon-dioxide-emissions-by-sector.csv"

# Methane per sector
meth_per_sect <- "data/raw/emission_per_sect/methane-emissions-by-sector-gg-coe.csv"

# Nitrous Oxide per sector
no2_per_sect <- "data/raw/emission_per_sect/nitrous-oxide-emissions-by-sector.csv"

# Greenhouse gas emission per sector
gge_per_sect <- "data/raw/emission_per_sect/greenhouse-gas-emissions-by-sector.csv"

processCsvData <- function(csv_filename) {
  csv_df <- read.csv(csv_filename) %>% 
    clean_names() %>% 
    na.omit()
  return(csv_df)
}

# Employment per activity filename
empl_per_act_df <- processCsvData(empl_per_act_filename)

# Country Emission DF (Total GHG)
# Don't worry about negative emissions : https://www.nrcan.gc.ca/our-natural-resources/forests-forestry/state-canadas-forests-report/how-does-disturbance-shape-canad/indicator-carbon-emissions-removals/16552
ghg_emission <- processCsvData(gge_per_sect) %>% 
  mutate(emission_sum = rowSums(.[3:12]))

# Country Emission DF (mtCO2)
# Add columns to emission data frame to convene to GDP growth per sector df
# TODO : Add columns for all sectors not just agriculture
ce_df <- read.csv(country_emissions_filename, skip=2) %>% 
  clean_names() %>% 
  rename(agriculture_em = agriculture_mt_co2e) %>% 
  rename(total_ghg_emissions = total_ghg_emissions_including_land_use_change_and_forestry_mt_co_e)

# Regulation per country DF
reg_df <- processCsvData(regulation_filename)

# Environmental tax per country DF
env_tax_df <- processCsvData(emission_tax_filename) %>% 
  dplyr::rename(year = time) %>% 
  select(-starts_with("indicator")) %>%
  dplyr::mutate(location = countrycode::countrycode(location, 'iso3c', 'country.name.en'))

# Per Country Activity Value Added DF
coun_growth_add_df <- processCsvData(activity_value_filename) %>% 
  dplyr::rename(activity = subject) %>% 
  dplyr::rename(year = time) %>% 
  select(-starts_with("indicator")) %>% # Remove Indicator 
  dplyr::mutate(location = countrycode::countrycode(location, 'iso3c', 'country.name.en')) %>% 
  filter(measure == "AGRWTH")

# Rename value added sector names to convene to emission dataset sector name
# Industry Mappings
subject_mappings <- tribble(
  ~code, ~name,
  "AGRFORTFISH", "Agriculture and Fishery",
  "CONSTR", "Construction",
  "FINANCEINS", "Finance and Insurance",
  "INDUSENRG", "Industry and Energy",
  "INFCOMM", "Information Communication",
  "MFG", "Manufacturing",
  "OTHSERVACT", "Other Service Activities",
  "PROSCISUPP", "Profesional and Scientific Support Services",
  "PUBADMINEDUSOC", "Public",
  "REALEST", "Real Estate",
  "SERV", "Services",
  "TOT", "Total Growth",
  "WHLEHTELTRANSP", "Wholesale, Retail, Trade, Transport, Accomodation"
)
coun_growth_add_df <- coun_growth_add_df %>% mutate(activity = mapvalues(activity, subject_mappings$code, subject_mappings$name)) 
  


# Rename Environment Tax Sectors
env_subject_mappings <- tribble(
  ~code, ~name,
  "ENRG", "Energy",
  "MOTORVEH", "Motored Vehicles",
  "OTH", "Other",
  "TOT", "Total Environmental Tax Generated"
)
env_tax_df <- env_tax_df %>% mutate(subject = mapvalues(subject, env_subject_mappings$code, env_subject_mappings$name))


countries_ce <- unique(ce_df$country)
countries_ce
countries_df <- unique(coun_ava_df$location)
countries_df

  


# Get Countries of Interest -----------------------------------------------

# Vinh Version 
country_ghg_emissions <- 
  read_csv('data/raw/CAIT-Country-GHG-Emissions.csv', skip=2) %>% 
  clean_names() %>% 
  select(country, year, total_ghg_emissions_mtco2e = total_ghg_emissions_including_land_use_change_and_forestry_mt_co_e) %>% 
  na.omit()

# Avg emissions of all types per country
country_avg_emissions <- country_ghg_emissions %>% 
  select(-year) %>% 
  filter(country != 'World', !str_detect(country, 'European Union')) %>% 
  group_by(country) %>% 
  summarise_each(list(avg_ghg_emissions_mtco2e = mean))

# View only top n percent countries based on ghg emissions
percent_ghg <- 0.80
country_top_avg_emissions <- country_avg_emissions %>% 
  select(country, avg_ghg_emissions_mtco2e) %>% 
  arrange(avg_ghg_emissions_mtco2e %>% desc()) %>%
  mutate(cum_percent_ghg = cumsum(avg_ghg_emissions_mtco2e)/sum(avg_ghg_emissions_mtco2e),
         percent_global_ghg_emissions = avg_ghg_emissions_mtco2e / sum(avg_ghg_emissions_mtco2e))%>% 
  filter(cum_percent_ghg < percent_ghg) %>% 
  select(-cum_percent_ghg)

p <- country_top_avg_emissions %>%
  select(country) %>%
  inner_join(country_ghg_emissions,by='country') %>%
  mutate(country = fct_reorder(country, total_ghg_emissions_mtco2e, tail, n=1, .desc=TRUE)) %>% 
  ggplot(aes(x=year, y=total_ghg_emissions_mtco2e, colour=country)) +
  geom_line() +
  labs(
    title = 'GHG emission per country',
    y= 'GHG emission (MtCO2e)',
    x = 'Year',
    colour = 'Country'
  ) +
  theme_hc()

ggplotly(p)

# Avg emissions of all types per country (mtCO2)

country_avg_emissions <- ce_df %>% 
  select(-year) %>% 
  filter(country != 'World', !str_detect(country, 'European Union')) %>% 
  group_by(country) %>% 
  summarise_each(list(mean = mean))

p <- country_top_avg_emissions %>%
  select(country) %>%
  inner_join(country_ghg_emissions,by='country') %>%
  mutate(country = fct_reorder(country, total_ghg_emissions_mtco2e, tail, n=1, .desc=TRUE)) %>% 
  ggplot(aes(x=year, y=total_ghg_emissions_mtco2e, colour=country)) +
  geom_line() +
  labs(
    title = 'GHG emission per country',
    y= 'GHG emission (MtCO2e)',
    x = 'Year',
    colour = 'Country'
  ) +
  theme_hc()

ce_df_freq <- data.frame(table(ce_df$country))

# Avg emission for all GHG (in tonnes of ghg) [Missing years]
# ghg_avg_emissions -> ghg_emission %>% 
#   group_by(entity)

# Barplot of top 20 countries avg ghg emission
country_avg_emissions %>% 
  rename(avg_ghg_emissions = total_ghg_emissions_including_land_use_change_and_forestry_mt_co_e_mean) %>% 
  top_n(20, wt=avg_ghg_emissions) %>% 
  ggplot(aes(reorder(country, avg_ghg_emissions), avg_ghg_emissions)) +
  geom_bar(stat='identity') +
  coord_flip() + 
  labs(
    title = 'Top 20 countries based on their average GHG emissions',
    x = 'Country',
    y = 'Average GHG emission per year (MtCO2e)'
  ) +
  theme_hc()

# Thus these our countries of interest
countries_of_interest <-
  tribble(
    ~country,
    'United States',
    'China',
    'India',
    'Australia',
    'Chile',
    'Colombia',
    'Germany',
    'Japan',
    'Brazil',
    'Canada'
  )


# Measure used should be Percent of total tax
# env_tot_tax_df <- env_tax_df %>% 
#   filter(measure == "PC_TOT_TAX")


# Per Activity Growth Added DF(total growth added per year per country)
int_ava_df <- growth_added %>% 
  dplyr::group_by(activity, year) %>% 
  dplyr::summarise(average_val = mean(value))


# Start with different subsectors for same country 

# International Average value added per year
int_ava_df %>%
  ggplot(
    aes(
      x = (year),
      y = (average_val),
      color = activity
    )
  ) +
  geom_point(size = 2) +
  geom_smooth(se = FALSE, method = lm) +
  facet_grid(rows = vars(activity)) +
  labs(
    x = "Year",
    y = "Value Added",
    colour = 'Activity Category',
    title = "Economical Value Added vs Year"
  )

# Per Average Value added DF(global value added per year)
coun_ava_df <- growth_added %>% 
  dplyr::group_by(location, activity, year)
  # %>% dplyr::summarise(average_val = mean(value))
  
# Emission and growth per sector merged df
em_growth_merged_df <- dplyr::left_join(ce_df, coun_growth_add_df, by = c("country" = "location", "year" = "year"))

# Agriculture and Fishery Growth Contribution

agr_growth_em_df <- em_growth_merged_df %>% 
  filter(activity == "Agriculture and Fishery")

# Loop through countries of interest
countries_ccf_res <- tribble()
for (i in 1:nrow(countries_of_interest)) {
  country <- countries_of_interest[i,]$country
  print(country)
  ccf_res <- findTotalCrossCorr(em_growth_merged_df, country)
  countries_ccf_res <- bind_rows(countries_ccf_res, ccf_res)
}

countries_ccf_res %>%
  ggplot(
    aes(
      x = (LAG),
      y = (ACF),
      color = country
    )
  ) +
  geom_point(aes(size = dist)) +
  # geom_smooth(se = FALSE, method = lm) +
  # facet_grid(rows = vars(activity)) +
  labs(
    x = "LAG (Delay between correlation)",
    y = "ACF (Auto-correlation between Time-Series)",
    colour = 'Country',
    title = "Significant Cross Correlation Between Total Growth and Total Emissions Time Series"
  )

# test_df <- findAgrCrossCorr("United States") %>% mutate(country = "Hello")



# Find cross correlations between Total Growth and And Emissions for Given Country
findTotalCrossCorr <- function(em_growth_df, country_name) {
  
  country_growth_em <- em_growth_df %>% 
    filter(activity == "Total Growth") %>% 
    filter(country == country_name)
  
  if (dim(country_growth_em)[1] == 0) {
   return(tribble(~ACF, ~LAG, ~country, ~dist, NA, NA, country_name, NA)) 
  }
  
  min_year <- min(country_growth_em$year)
  print(min_year)
  
  print("Making Time series")
  country_Growth_TimeSeries <- ts(country_growth_em$value, start = min_year) %>% stationarize()
  print(country_Growth_TimeSeries)
  country_Emission_TimeSeries <- ts(country_growth_em$total_ghg_emissions, start = min_year) %>% stationarize()
  print(country_Emission_TimeSeries)
  
  print("making ccf")
  ccf2 <- ccf(country_Growth_TimeSeries, country_Emission_TimeSeries)
  print("Done making ccf")
  
  # Critical Values at 5% conf Level = +-2/sqrt(n) (assuming normal distribution of ACF)
  crit_val_lb <- (-2 / sqrt(ccf2$n.used))
  crit_val_ub <- (2 / sqrt(ccf2$n.used))
  
  print("making xcorr")
  xcorrDF <- data.frame(ACF = ccf2$acf, LAG = ccf2$lag) %>% 
    mutate(country = country_name) %>% 
    mutate(dist = sapply(ACF, findSignificance, upper_bound = crit_val_ub, lower_bound = crit_val_lb)) %>% 
    filter(ACF >= crit_val_ub | ACF <= crit_val_lb)
  
  print("Done making xcorr")
  return(xcorrDF)
  
}

# Country Example
country_growth_em <- em_growth_merged_df %>% 
  filter(activity == "Total Growth") %>% 
  filter(country == "Germany")

min_year <- min(country_growth_em$year)
print(min_year)

country_Growth_TimeSeries <- ts(country_growth_em$value, start = min_year) %>% stationarize()
country_Emission_TimeSeries <- ts(country_growth_em$total_ghg_emissions, start = min_year) %>% stationarize()

ccf2 <- ccf(country_Growth_TimeSeries, country_Emission_TimeSeries)

# Critical Values at 5% conf Level = +-2/sqrt(n) (assuming normal distribution of ACF)
crit_val_lb <- (-2 / sqrt(ccf2$n.used))
crit_val_ub <- (2 / sqrt(ccf2$n.used))

df <- data.frame(ACF = ccf2$acf, LAG = ccf2$lag) 

xcorrDF <- data.frame(ACF = ccf2$acf, LAG = ccf2$lag) %>% 
  mutate(country = "Germany") %>%
  mutate(dist = sapply(ACF, findSignificance, upper_bound = crit_val_ub, lower_bound = crit_val_lb)) %>%
  filter(ACF >= crit_val_ub | ACF <= crit_val_lb) 

countries_ccf_res <- bind_rows(countries_ccf_res, xcorrDF)


findSignificance <- function(acf, upper_bound, lower_bound){
  print("ACF")
  print(acf)
  print("Upp bound")
  print(upper_bound)
  print("Lower bound")
  print(lower_bound)
  if ( acf >= upper_bound) {
    return(acf - upper_bound)
  } else if (acf <= lower_bound) {
    return(abs(acf - lower_bound))
  } else {
    return((-1) * min(abs(upper_bound - acf), abs(lower_bound - acf)))
  }
}



# Trend Stationarize a time series
stationarize <- function(time_series) {
  
  adf_test <- time_series %>% adf.test()
  adf_p <- adf_test$p.value
  print("P value")
  print(adf_p)
  while (adf_p > 0.05) {
    time_series <- time_series %>% diff()
    adf_test <- time_series %>% adf.test()
    adf_p <- adf_test$p.value
  }
  
  kpss_test <- time_series %>% kpss.test()
  kpss_p <- kpss_test$p.value
  print("P value")
  print(kpss_p)
  while (kpss_p < 0.05) {
    time_series <- time_series %>% diff()
    kpss_test <- time_series %>% kpss.test()
    kpss_p <- kpss_test$p.value
  }
  
  print("Done stationarizing")
  return(time_series)
}


aus_growth_em <- agr_growth_em_df %>% filter(country == "Australia")

# First let's assume that Value added and environmental tax are independent to one another
# to perform Pearson corelation test
# We also assume there is a linear relationship between the two

# Assume That both variables are continuous and linearly related (appears linear barring outliers)
plot(aus_growth_em$value, aus_growth_em$agriculture_em)

# Assume variables follow a bivariate normal distribution
qqnorm(aus_growth_em$value)
qqline(aus_growth_em$value)

qqnorm(aus_growth_em$agriculture_em)
qqline(aus_growth_em$agriculture_em)

# Assume variances are homogeneous (no cone shape scatter plot)

# No Major outliers (check scatter plot)

# Correlation test
cor.test(aus_growth_em$value, aus_growth_em$agriculture_em, method = "pearson", data=aus_val_tax)

# Output -> Non Significant negative corelation

# Let's plot two time series 

# one for Added growth wrt years
Agriculture_Growth_TimeSeries <- ts(aus_growth_em$value, start = 1996)
Agriculture_Emission_TimeSeries <- ts(aus_growth_em$agriculture_em, start = 1996)
bound_ts <- cbind(Agriculture_Growth_TimeSeries, Agriculture_Emission_TimeSeries)
autoplot(bound_ts, facets=TRUE) +
  xlab("Year") + ylab("") +
  ggtitle("Time Series for Australian Agricultural Subsector")

scatter_ts_plot <- 
  qplot(Agriculture_Growth_TimeSeries, Agriculture_Emission_TimeSeries, data=as.data.frame(bound_ts)) +
  ylab("Emission (mtCO2)") + xlab("Added Growth")

# Cross corelation testing for time series

# First test for stationarity (the way the time series changes does not change over time)

adf.test(Agriculture_Growth_TimeSeries) # Low p-value indicating stationary

kpss.test(Agriculture_Growth_TimeSeries) # High p-value indicating non-trend-stationary

adf.test(Agriculture_Emission_TimeSeries) # High p-value indicating non-stationary

kpss_t <- kpss.test(Agriculture_Emission_TimeSeries) # High p-value indicating non-trend-stationary

diff_agr_grwt_ts <- diff(Agriculture_Growth_TimeSeries)

diff_agr_em_ts <- diff(Agriculture_Emission_TimeSeries)

# Re-test for Stationarity

diff_agr_grwt_ts %>% diff() %>% diff() %>% diff() %>% diff() %>% diff() %>% adf.test() # Low p-value indicating stationary

diff_agr_grwt_ts %>% diff() %>% diff() %>% diff() %>% diff() %>% diff() %>% kpss.test() # High p-value indicating non-trend-stationary

diff_agr_grwt_ts <- diff_agr_grwt_ts %>% diff() %>% diff() %>% diff() %>% diff() %>% diff() 

# growth IS Trend-Stationary

diff_agr_em_ts %>% diff() %>% diff() %>% diff() %>% diff() %>% diff() %>% adf.test() # Low p-value indicating stationary

diff_agr_em_ts %>% diff() %>% diff() %>% diff() %>% diff() %>% diff() %>% kpss.test() # High p-value indicating non-trend-stationary

diff_agr_em_ts <- diff_agr_em_ts %>% diff() %>% diff() %>% diff() %>% diff() %>% diff()

# Emission is growth stationary

# Cross correlation

ccf2 <- ccf(diff_agr_grwt_ts, diff_agr_em_ts)

lb <- (-2 / sqrt(ccf2$n.used))

up <- (2/ sqrt(ccf2$n.used))

data.frame(ACF = ccf2$acf, LAG = ccf2$lag)

xcorrDF <- data.frame(ACF = ccf2$acf, LAG = ccf2$lag) %>% filter(ACF >= up | ACF <= lb)


print(ccf2$acf)
# Negatively correlated in -2 lag
# Positively correlated in -1 and -3 lag
# Not sure if i took differencing into account TODO: apply ARIMA MOdel


agr_arima_1 <- diff_agr_em_ts %>% 
  model(arima = ARIMA())



# Australia value added per year for Agriculture Sector
# aus_val_tax %>%
#   ggplot(
#     aes(
#       x = (year),
#       y = (value),
#       color = activity
#     )
#   ) +
#   geom_point(size = 2) +
#   geom_smooth(se = FALSE, method = lm) +
#   facet_grid(rows = vars(activity)) +
#   labs(
#     x = "Year",
#     y = "Value Added",
#     colour = 'Activity Category',
#     title = "Economical Value Added vs Year In Australia"
#   )
# 
# aus_val_tax %>% 
#   ggplot(
#     aes(
#       x = (year),
#       y = (total_env_tax),
#       color = activity
#     )
#   ) +
#   geom_point(size = 2) +
#   geom_smooth(se = FALSE, method = lm) +
#   facet_grid(rows = vars(activity)) +
#   labs(
#     x = "Year",
#     y = "Environment Tax Income",
#     colour = 'Activity Category',
#     title = "Environment Tax Income vs Year In Australia"
#   )



